---
title: "Cartel detection"
author: "Margherita Atzei, Sebastian Kimm Friedberg, Oscar Krumlinde, Filip Mellgren"
date: '2020-03-11'
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(tidyverse)
library(viridis)
library(patchwork)
df <- rio::import("Data_Buehler_Wallimann.xlsx")
```
# First behavoural screen
## Set parameters
```{r}
dc <- 0.7 # Decision criteria cut off
```

## Create summary statistics
These statistics are based on those in the ML paper.

```{r, include = FALSE}
# Create statistics used for behavioral screening 
df %>% arrange(project, bid) %>% group_by(project) %>% 
   mutate(
     pairwise_diff = bid - lag(bid, order_by=bid)) %>%
  summarise(
    mean_bid = mean(bid), 
    no_bids = n(),
    sdev_bid = sd(bid), # NOTE: sd() defaults t0 denom n-1, want n.
    win_bid = min(bid),
    date = first(anonymiseddate), 
    year = first(anonymisedyear), 
    contract_type = first(contract_type), 
    procedure = first(procedure),
    diff = min(bid[bid!=min(bid)]) - min(bid),
    kurt = sum( ((bid - mean(bid)) / sdev_bid)^4),
    skew = sum( ((bid - mean(bid)) / sdev_bid)^3),
    rd = diff/sqrt(var((bid[bid!=min(bid)]))),
    altrd = (no_bids - 1) * diff / (sum(pairwise_diff, na.rm = TRUE) - diff),
    altrd2 = (no_bids - 1) * diff / (min(bid[bid!=min(bid)]) - max(bid)) # Equivalent magnitude (but takes reversed sign into account)
    ) %>%
  mutate(
    CV = 100* (sdev_bid / mean_bid) * sqrt((no_bids-1)/(no_bids)), # Note that we multiply by 100 and use pop variance
    kurt = kurt * no_bids*(no_bids+1) / ((no_bids - 1)*(no_bids - 2)* (no_bids - 3)),
    kurt = kurt - 3 * (no_bids - 1)^3 / ((no_bids - 2) * no_bids - 3),
    skew = skew * no_bids / ( (no_bids - 1) * (no_bids -2) ),
    date2 = (date-1)/(365.25) + 1 # take gap years into account
    ) -> df_agg
```

```{r cleaning}
# NOTE that many observations dissapear here
# Lost observations due to missings: 4434 - 3811 = 623
df_agg %>% select(project, CV, no_bids, contract_type) %>% filter_all(any_vars(!is.infinite(df_agg$altrd))) %>% na.omit() -> df_agg_filtered

df_agg <- left_join(df_agg_filtered, df_agg)

# clean away extreme values of altrd
#df_agg <- df_agg %>% filter(altrd < 10)
```

## Apply model
In the ML paper, the authors fit a logistic regression and give the coefficients. We simply use these coefficients to generate predictions. Important, this implicitly assumes our data come from the same distribution as the data found in the ML paper. This assuption must be discussed when we present our evidence.

Also,  note that this is only an exploratory anb rough draft so far and that there are some things to do before the actual graphs can be produced. 

```{r model}
# Alternatice way: force coefficients: https://tolstoy.newcastle.edu.au/R/e2/help/07/08/24294.html
m3 <- c(1.02, -0.49, 0.92, 0.09)
m4 <- c(1.51, -0.47, 0.95, 0)
names(m3) <- c("CONST", "CV", "ALTRD", "NoBIDS")
names(m4) <- names(m3)
# Use model 4 because number of bids is insignificant in model 3
model <- m4

df_agg %>%
  mutate(
    probability_collusion = 1 / (1 + exp(-(model["CONST"] + model["CV"] * CV + 
                                             model["ALTRD"] * altrd +
                                             model["NoBIDS"] * no_bids)))
    ) -> df_agg
```


```{r pcol}
df_agg %>% ggplot(aes(x=probability_collusion)) + 
  theme_minimal() +
  geom_density() + scale_colour_continuous(type='viridis') +
  labs(x = "Probability of collusion", 
       title = "Density plot of probability of collusion")
```
## Create confusion matrix

```{r}
# Data from ML paper fig 3
TP <- c(1, 0.91, 0.85, 0.77, 0.64, 0.38)
TN <- c(0, 0.69, 0.78, 0.86, 0.91, 0.97)
FP <- 1 - TN
FN <- 1 - TP
dc_vec <- c(0, 0.5, 0.6, 0.7, 0.8, 0.9)
certainty_info <- cbind(dc_vec, TP, TN, FP, FN) %>% as_tibble()
# Use decision criteria, dc, to classify observations
df_agg <- df_agg %>% mutate(pred_cartel = if_else(probability_collusion > dc, 1, 0))
```

```{r confusion_matrix}
dc_ix <- which(dc_vec == dc)
num_cartel_pred <- df_agg %>% filter(probability_collusion >= dc) %>% nrow()
num_fair_pred <- df_agg %>% filter(probability_collusion < dc) %>% nrow()

# Prepare data
conf_actual <- c("Cartel", "Fair")
conf_pred <- c("Cartel", "Fair")
conf_mat <- expand.grid(X=conf_pred, Y=conf_actual)
conf_mat$conf_data <- c(TP[[dc_ix]] , FN[[dc_ix]], 
                        FP[[dc_ix]], TN[[dc_ix]])
conf_mat$colors <- c(0,1,1,0)

# Plot the confusion matrix
conf_mat %>% ggplot(aes(conf_mat$X, conf_mat$Y)) +
  geom_tile(aes(fill = colors)) + 
  labs(title = "Model accuracy", subtitle = "Expected fraction of predicted status by true status",
       y = "Actual cartel status", x = "Predicted cartel status") + 
  theme_minimal() +
  geom_text(aes(label = round(conf_data, 2)),size = 8, color = "white") +
  scale_fill_gradient2(low = "skyblue", high = "coral", mid = "white", 
   midpoint = 0.5, limit = c(0,1.2), space = "Lab", 
    name="") +
  theme(legend.position = "none")
ggsave("images/confmat.png")
```
## Plot densities of occurences.

```{r density_distribution}
df_classified <- df_agg %>%
  mutate(pos = if_else(probability_collusion > dc, 1, 0),
         contr_type = contract_type,
         pos2 = pos) %>%
  unite(col = "dens_cat", c(pos2, contr_type ))

plot_dist <- function(data, contract, category_name){
  data %>% filter(contract_type %in% contract) %>%
  ggplot(aes(x = date2, color = as.factor(pos), fill = as.factor(pos))) +
  geom_histogram(alpha = 0.6, show.legend = FALSE,  binwidth = 1, position = "fill") +
    geom_rug(data = data %>% filter(pos == 1, contract_type == contract), size = 0.75) +
    scale_color_manual(name = "Predicted \n status", values=c("skyblue", "coral"), labels = c("Fair", "Cartel")) +
    scale_fill_manual(values=c("skyblue", "coral")) +
    theme_minimal() + labs(x = "") +
    #theme(legend.position = "None") +
    labs(title = category_name, y = "Fraction") +
    geom_hline(yintercept=FP[[dc_ix]], linetype="dashed", 
                color = "black", size=0.5) +
    xlim(min(floor(df_classified$date2)) - 1, max(floor(df_classified$date2)) +1)
}

dist_cat1 <- plot_dist(df_classified, 1, "Strassenbau") + theme(legend.position = "None")
dist_cat2 <- plot_dist(df_classified, 2, "Strassen und Tiefbau")
dist_cat3 <- plot_dist(df_classified, 3, "Tiefbau") + theme(legend.position = "None")

dist_cat1 / dist_cat2 / dist_cat3 + 
  labs(caption = "Note: - - - - denotes the fraction of expected predicted cartels given no cartel (false positives)", x = "Year")
ggsave("images/densities.png")
```

```{r ks_test}
kstest_contract <- function(df, type){
  # Tests whether the distribution of all predicted cartels follow the same 
  # distribution as all predicted non cartels
  x <- df %>% filter(pos == 1) %>% filter(contract_type == type) %>% select(date)
  y <- df %>% filter(pos == 0) %>% filter(contract_type == type) %>% select(date)
  x <- x$date
  y <- y$date
  ks.test(x, y)
}

# Test whether events deemed fair respecitve collusive occur at different points in time
kstest_contract(df_classified, 1)
kstest_contract(df_classified, 2)
kstest_contract(df_classified, 3)
```

```{r cv_time}
bp_tief_y <- 11
bp_str_y <- 6

df_agg %>% select(project, year, contract_type, CV) %>% 
  group_by(year, contract_type) %>% 
  summarise(avg_cv = mean(CV)) %>%
  ggplot(aes(x = year, y = avg_cv, color = as.factor(contract_type))) + 
  geom_line() +
  theme_minimal() +
  scale_color_discrete(name = "Contract type", labels = c("Strassenbau", "Strassen und Tiefbau", "Tiefbau")) +
  labs(y = "Yearly Mean Coeff. of Variation", x = "Year", 
       title = "Cartels are more likely marked by low values",
       caption = "- - - - indicate potential break point") +
  geom_vline(aes(xintercept = bp_str_y), 
             linetype="dotted", size=1, color = "red", alpha = 0.5) +
  geom_vline(aes(xintercept = bp_tief_y), 
             linetype="dotted", size=1, color = "blue", alpha = 0.5)

ggsave("images/CV_year.png")
```

# Plot CV over time


```{r find_bp}
# Find break points based on visual inspection of CV
bp_tief <- round(bp_tief_y * 365.25, 0)
bp_str <- round(bp_str_y * 365.25, 0)

```

```{r test_bp}
library(strucchange)

chow_test <- function(df, bp){
  sc <- sctest(df$altrd ~ df$date, type = "Chow", point = bp)
  return(sc)
}

df_str <- df_agg %>% filter(contract_type == 1) %>% 
  mutate(dist_to_bp = abs(bp_str - date)) %>% select(dist_to_bp, date, altrd)
bp_str_date <- which(df_str$dist_to_bp == min(df_str$dist_to_bp))

df_tief <- df_agg %>% filter(contract_type == 3) %>% 
  mutate(dist_to_bp = abs(bp_tief - date)) %>% select(dist_to_bp, date, altrd)
bp_tief_date <- which(df_tief$dist_to_bp == min(df_tief$dist_to_bp))

# Test break points on altrd, which wasn't used to find break points
chow_test(df_str, 135) 
chow_test(df_tief, bp_tief_date)
```



# Second behavioural screen Time series for structural breaks
Afer meeting. Do a structural break which provides further evidence. Improtant to invclude as further evidence.

Idea is to identify break points in one metric and then use a Chow test to test for structural breaks in another important statistic.


Find markers from OECD summary, look at CV, when it is low, there is an increased likelihood of a cartel. 

Also, Difference between the two lowest bids divided by the standard deviation of the "cover bids" (all bids that did not win)".

Descriptive statistics, by type:
Procedure type (var, mean, bids)